<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Light Order Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f7fa;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      text-align: center;
      color: #0057b8;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .item-line {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
      gap: 10px;
      margin-top: 10px;
    }
    .remove-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-btn, .submit-btn, .whatsapp-btn, .send-receipt-btn {
      margin-top: 20px;
      padding: 10px 20px;
      border: none;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    .add-btn {
      background: #007bff;
      color: white;
    }
    .submit-btn {
      background: #28a745;
      color: white;
    }
    .whatsapp-btn {
      background: #25D366;
      color: white;
    }
    .send-receipt-btn {
      background: #673ab7;
      color: white;
    }
    .total-display {
      margin-top: 15px;
      text-align: right;
      font-weight: bold;
      font-size: 18px;
    }
    #qrCode {
      margin-top: 20px;
      text-align: center;
    }
    .info-note {
      margin-top: 15px;
      font-style: italic;
      color: #555;
      text-align: center;
    }
  </style>
</head>
<body>

  <h2>Multi-Product Light Order</h2>

  <form id="lightForm">
    <label>Customer Name:</label>
    <input type="text" name="customer" required>

    <label>Customer Email:</label>
    <input type="email" name="email" required>

    <div id="itemsContainer">
      <label>Products:</label>
      <div class="item-line">
        <input type="text" name="lightType[]" placeholder="Type" required>
        <input type="number" name="quantity[]" placeholder="Qty" min="1" required>
        <input type="number" name="price[]" placeholder="Price" min="0" step="0.01" required>
        <input type="number" name="discount[]" placeholder="Disc%" value="0" min="0" max="100">
        <input type="text" name="itemTotal[]" placeholder="Total" readonly>
        <button type="button" class="remove-btn" style="display:none;">×</button>
      </div>
    </div>

    <button type="button" class="add-btn" id="addItemBtn">+ Add Item</button>

    <label>Order Status:</label>
    <select name="orderStatus" id="orderStatus">
      <option value="Pending">Pending</option>
      <option value="Accepted">Accepted</option>
      <option value="Delivered">Delivered</option>
    </select>

    <div class="total-display">
      Grand Total: ₹<span id="grandTotal">0.00</span>
    </div>

    <button type="submit" class="submit-btn">Submit Order</button>
    <button type="button" class="whatsapp-btn" id="whatsappBtn">Send Order via WhatsApp</button>
    <button type="button" class="send-receipt-btn" id="sendReceiptBtn">Send Receipt via WhatsApp</button>

    <div class="info-note">
      After order submission, the owner will contact you with payment instructions and QR code.
    </div>
  </form>

  <div id="qrCode"></div>

  <script>
    const form = document.getElementById("lightForm");
    const container = document.getElementById("itemsContainer");
    const grandTotalEl = document.getElementById("grandTotal");
    const qrDiv = document.getElementById("qrCode");
    let qrCode;

    function calculateTotal() {
      let total = 0;
      document.querySelectorAll(".item-line").forEach((line) => {
        const qty = parseFloat(line.querySelector('input[name="quantity[]"]').value) || 0;
        const price = parseFloat(line.querySelector('input[name="price[]"]').value) || 0;
        const disc = parseFloat(line.querySelector('input[name="discount[]"]').value) || 0;

        let itemTotal = qty * price;
        if (disc > 0) itemTotal -= (itemTotal * disc / 100);
        line.querySelector('input[name="itemTotal[]"]').value = itemTotal.toFixed(2);
        total += itemTotal;
      });
      grandTotalEl.textContent = total.toFixed(2);
      generateQRCode(total.toFixed(2));
    }

    function generateQRCode(total) {
      const name = form.customer.value.trim();
      const email = form.email.value.trim();
      if (!name || !email) {
        qrDiv.innerHTML = '';
        qrCode = null;
        return;
      }
      let text = `Customer: ${name}\nEmail: ${email}\nTotal: ₹${total}`;
      if (!qrCode) {
        qrCode = new QRCode(qrDiv, {
          text: text,
          width: 180,
          height: 180,
        });
      } else {
        qrCode.clear();
        qrCode.makeCode(text);
      }
    }

    function createItemRow() {
      const row = document.createElement("div");
      row.className = "item-line";
      row.innerHTML = `
        <input type="text" name="lightType[]" placeholder="Type" required>
        <input type="number" name="quantity[]" placeholder="Qty" min="1" required>
        <input type="number" name="price[]" placeholder="Price" min="0" step="0.01" required>
        <input type="number" name="discount[]" placeholder="Disc%" value="0" min="0" max="100">
        <input type="text" name="itemTotal[]" placeholder="Total" readonly>
        <button type="button" class="remove-btn">×</button>
      `;

      row.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", calculateTotal);
      });

      row.querySelector(".remove-btn").addEventListener("click", () => {
        row.remove();
        calculateTotal();
        updateRemoveButtons();
      });

      container.appendChild(row);
      updateRemoveButtons();
    }

    function updateRemoveButtons() {
      const removeButtons = document.querySelectorAll(".remove-btn");
      removeButtons.forEach(btn => {
        btn.style.display = document.querySelectorAll(".item-line").length > 1 ? "inline-block" : "none";
      });
    }

    // Initial setup
    form.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", calculateTotal);
    });

    document.getElementById("addItemBtn").addEventListener("click", () => {
      createItemRow();
    });

    // Form submission
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      fetch("https://script.google.com/macros/s/AKfycbwd02hqw9-XTsKaGb7dU-HzXJPModbAT8h8EHOIOmNifvPo2l-se7jfmVhn0au_jR8d/exec", {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(data => {
        alert("Order submitted successfully!\nThe owner will contact you with payment instructions.");
        form.reset();
        // Remove all item lines except the first one
        document.querySelectorAll(".item-line").forEach((line, i) => {
          if (i > 0) line.remove();
        });
        calculateTotal();
        qrDiv.innerHTML = '';
        qrCode = null;
      })
      .catch(err => alert("Submission failed: " + err.message));
    });

    // WhatsApp Order Summary button
    document.getElementById("whatsappBtn").addEventListener("click", () => {
      const name = form.customer.value.trim();
      const email = form.email.value.trim();
      const status = form.orderStatus.value;
      if (!name || !email) {
        return alert("Please fill Customer Name and Email before sending.");
      }
      let message = `*Light Order Summary*\n\nName: ${name}\nEmail: ${email}\nStatus: ${status}\n\n`;

      document.querySelectorAll(".item-line").forEach((line) => {
        const type = line.querySelector('input[name="lightType[]"]').value;
        const qty = line.querySelector('input[name="quantity[]"]').value;
        const price = line.querySelector('input[name="price[]"]').value;
        const total = line.querySelector('input[name="itemTotal[]"]').value;
        message += `• ${type} - ${qty} x ₹${price} = ₹${total}\n`;
      });

      message += `\nGrand Total: ₹${grandTotalEl.textContent}`;

      const phone = prompt("Enter WhatsApp Number (with country code):", "+91");
      if (phone) {
        const encoded = encodeURIComponent(message);
        window.open(`https://wa.me/${phone}?text=${encoded}`, "_blank");
      }
    });

    // Send Receipt button - only if status = Accepted
    document.getElementById("sendReceiptBtn").addEventListener("click", () => {
      if (form.orderStatus.value !== "Accepted") {
        return alert("Order must be marked as 'Accepted' to send receipt.");
      }

      const name = form.customer.value.trim();
      if (!name) {
        return alert("Customer Name is required.");
      }

      let message = `*Receipt*\nHi ${name}, your order has been accepted.\nTotal Payable: ₹${grandTotalEl.textContent}\nThank you!`;

      const phone = prompt("Enter Customer WhatsApp Number:");
      if (phone) {
        const encoded = encodeURIComponent(message);
        window.open(`https://wa.me/${phone}?text=${encoded}`, "_blank");
      }
    });

    // Initial calculations and UI setup
    calculateTotal();
    updateRemoveButtons();
  </script>
</body>
</html>
